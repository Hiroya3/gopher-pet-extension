<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'none';
        img-src {{cspSource}};
        style-src 'unsafe-inline';
        script-src 'unsafe-inline';
    ">
</head>

<body>
    <div id="game-container">
        <img id="gopher" class="run" src="{{gopherUri}}" alt="Gopher Pet">
        <div id="stone-container"></div>
        <div id="score-display">Score: 0</div>
        <div id="game-over" class="hidden">
            <div>Game Over!</div>
            <div id="final-score"></div>
            <div>Press Space to restart</div>
            <div class="exit-hint">Press Esc to exit</div>
        </div>
    </div>
</body>

<style>
    body {
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        overflow: hidden;

        background-image: url('{{backgroundUri}}');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }

    #game-container {
        position: relative;
        width: 100%;
        height: 100%;
    }

    #gopher {
        width: 60px;
        z-index: 2;
        position: absolute;
        bottom: 0;
        transition: bottom 0.3s ease-out;
    }

    .stone {
        width: 40px;
        height: 40px;
        position: absolute;
        bottom: 0;
        z-index: 1;
    }

    @keyframes move-left {
        0% { right: -40px; }
        100% { right: calc(100% + 40px); }
    }

    .stone-moving {
        animation: move-left 2s linear forwards;
    }

    @keyframes run-right {
        0% { transform: translateX(-100vw); }
        100% { transform: translateX(100vw); }
    }

    .run {
        animation: run-right 10s linear infinite;
    }

    .game-mode {
        animation: none !important;
        left: 30px !important;
        transform: none !important;
    }

    .jumping {
        bottom: 100px !important;
    }

    @keyframes hit-spin {
        0% {
            transform: rotate(0deg) translateY(0);
            opacity: 1;
        }
        20% {
            transform: rotate(360deg) translateY(-50px);
        }
        40% {
            transform: rotate(720deg) translateY(-80px);
        }
        60% {
            transform: rotate(1080deg) translateY(-60px);
        }
        80% {
            transform: rotate(1440deg) translateY(-20px);
        }
        100% {
            transform: rotate(1800deg) translateY(0);
            opacity: 1;
        }
    }

    .hit {
        animation: hit-spin 0.8s ease-out forwards !important;
    }

    @keyframes screen-shake {
        0%, 100% { transform: translateX(0); }
        10% { transform: translateX(-10px); }
        20% { transform: translateX(10px); }
        30% { transform: translateX(-8px); }
        40% { transform: translateX(8px); }
        50% { transform: translateX(-5px); }
        60% { transform: translateX(5px); }
        70% { transform: translateX(-3px); }
        80% { transform: translateX(3px); }
        90% { transform: translateX(-1px); }
    }

    .shake {
        animation: screen-shake 0.4s ease-out;
    }

    @keyframes impact-flash {
        0% { opacity: 0; transform: scale(0.5); }
        50% { opacity: 1; transform: scale(1.5); }
        100% { opacity: 0; transform: scale(2); }
    }

    .impact {
        position: absolute;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(255,255,0,0.8) 0%, rgba(255,100,0,0.4) 50%, transparent 70%);
        pointer-events: none;
        animation: impact-flash 0.3s ease-out forwards;
        z-index: 10;
    }

    #score-display {
        position: absolute;
        top: 10px;
        right: 10px;
        color: white;
        font-family: sans-serif;
        font-size: 16px;
        font-weight: bold;
        text-shadow: 1px 1px 2px black;
        display: none;
    }

    #score-display.visible {
        display: block;
    }

    #game-over {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-family: sans-serif;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        text-shadow: 2px 2px 4px black;
        background: rgba(0, 0, 0, 0.7);
        padding: 20px;
        border-radius: 10px;
    }

    #game-over.hidden {
        display: none;
    }

    #final-score {
        margin: 10px 0;
    }

    .exit-hint {
        margin-top: 10px;
        font-size: 14px;
        opacity: 0.7;
    }
</style>

<script>
    const vscode = acquireVsCodeApi();
    const gopher = document.getElementById('gopher');
    const gameContainer = document.getElementById('game-container');
    const stoneContainer = document.getElementById('stone-container');
    const scoreDisplay = document.getElementById('score-display');
    const gameOverDisplay = document.getElementById('game-over');
    const finalScoreDisplay = document.getElementById('final-score');
    const stoneImageSrc = '{{stoneUri}}';
    const gopherRunningSrc = '{{gopherUri}}';
    const gopherSpinningSrc = '{{spinningUri}}';

    let gameMode = false;
    let isJumping = false;
    let gameRunning = false;
    let score = 0;
    let stoneInterval = null;
    let collisionCheckInterval = null;
    let stones = [];

    window.addEventListener('message', event => {
        const message = event.data;
        if (message.type === 'startGame') {
            startGame();
        }
    });

    function startGame() {
        gameMode = true;
        gameRunning = true;
        score = 0;
        updateScore();

        gopher.src = gopherRunningSrc;
        gopher.classList.remove('run', 'hit');
        gopher.classList.add('game-mode');
        gameContainer.classList.remove('shake');
        scoreDisplay.classList.add('visible');
        gameOverDisplay.classList.add('hidden');

        // Clear existing stones
        stones.forEach(stone => stone.element.remove());
        stones = [];

        // Start spawning stones
        spawnStone();
        stoneInterval = setInterval(spawnStone, 1500 + Math.random() * 1000);

        // Start collision detection
        collisionCheckInterval = setInterval(checkCollision, 50);
    }

    function stopGame() {
        gameRunning = false;
        if (stoneInterval) {
            clearInterval(stoneInterval);
            stoneInterval = null;
        }
        if (collisionCheckInterval) {
            clearInterval(collisionCheckInterval);
            collisionCheckInterval = null;
        }

        // Switch to spinning gopher on collision
        gopher.src = gopherSpinningSrc;

        // Add impact effects
        gopher.classList.add('hit');
        gameContainer.classList.add('shake');

        // Create impact flash effect at gopher position
        const gopherRect = gopher.getBoundingClientRect();
        const containerRect = gameContainer.getBoundingClientRect();
        const impact = document.createElement('div');
        impact.className = 'impact';
        impact.style.left = (gopherRect.left - containerRect.left + gopherRect.width / 2 - 30) + 'px';
        impact.style.bottom = '20px';
        gameContainer.appendChild(impact);

        // Remove impact element after animation
        setTimeout(() => impact.remove(), 300);

        // Show game over after spin animation
        setTimeout(() => {
            finalScoreDisplay.textContent = 'Score: ' + score;
            gameOverDisplay.classList.remove('hidden');
        }, 800);
    }

    function exitGame() {
        // Stop game intervals
        gameRunning = false;
        gameMode = false;
        if (stoneInterval) {
            clearInterval(stoneInterval);
            stoneInterval = null;
        }
        if (collisionCheckInterval) {
            clearInterval(collisionCheckInterval);
            collisionCheckInterval = null;
        }

        // Clear all stones
        stones.forEach(stone => stone.element.remove());
        stones = [];

        // Reset gopher to normal running mode
        gopher.src = gopherRunningSrc;
        gopher.classList.remove('game-mode', 'hit', 'jumping');
        gopher.classList.add('run');
        gameContainer.classList.remove('shake');

        // Hide game UI
        scoreDisplay.classList.remove('visible');
        gameOverDisplay.classList.add('hidden');

        // Reset state
        isJumping = false;
        score = 0;
    }

    function spawnStone() {
        if (!gameRunning) return;

        const stone = document.createElement('img');
        stone.src = stoneImageSrc;
        stone.className = 'stone stone-moving';
        stoneContainer.appendChild(stone);

        const stoneObj = {
            element: stone,
            passed: false
        };
        stones.push(stoneObj);

        // Remove stone after animation completes
        stone.addEventListener('animationend', () => {
            if (!stoneObj.passed && gameRunning) {
                score++;
                updateScore();
                stoneObj.passed = true;
            }
            stone.remove();
            stones = stones.filter(s => s !== stoneObj);
        });
    }

    function updateScore() {
        scoreDisplay.textContent = 'Score: ' + score;
    }

    function checkCollision() {
        if (!gameRunning) return;

        const gopherRect = gopher.getBoundingClientRect();

        for (const stoneObj of stones) {
            const stoneRect = stoneObj.element.getBoundingClientRect();

            // Check for collision (with some padding for fairness)
            const padding = 10;
            if (
                gopherRect.left + padding < stoneRect.right - padding &&
                gopherRect.right - padding > stoneRect.left + padding &&
                gopherRect.bottom - padding > stoneRect.top + padding &&
                gopherRect.top + padding < stoneRect.bottom - padding
            ) {
                stopGame();
                return;
            }
        }
    }

    document.addEventListener('keydown', (event) => {
        if (event.code === 'Escape' && gameMode) {
            event.preventDefault();
            exitGame();
        } else if (event.code === 'Space') {
            event.preventDefault();

            if (gameMode && !gameRunning) {
                // Restart game
                startGame();
            } else if (gameMode && !isJumping) {
                jump();
            }
        }
    });

    function jump() {
        if (isJumping) return;

        isJumping = true;
        gopher.classList.add('jumping');

        setTimeout(() => {
            gopher.classList.remove('jumping');
            isJumping = false;
        }, 500);
    }

    window.focus();
</script>

</html>
